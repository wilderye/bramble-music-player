# 测试用例：开场白轮询监视器 (V9.5)

**测试日期**: 2025-12-21
**关联功能**: 开场白轮询监视器
**测试目标**: 验证非标准方式切换开场白时播放器能正确响应，且不影响现有功能

---

## 测试前准备

### 环境要求
- [ ] 酒馆助手已安装并运行
- [ ] 音乐播放器脚本已加载 (版本 9.5)
- [ ] 准备一个**带有多个开场白**的角色卡（至少 2 个开场白）
- [ ] 每个开场白配置了**不同的歌单**（便于验证切换效果）

### 控制台监控
在测试过程中，请打开浏览器开发者工具 (F12)，观察控制台日志中的以下关键词：
- `[GreetingWatcher]` - 轮询监视器相关日志
- `[SoftReset]` - 软重置相关日志
- `[Initializer]` - 初始化相关日志

---

## 一、核心功能测试

### TC-001: 原生滑动切换开场白（兼容性验证）

**目的**: 确保原有的 `MESSAGE_SWIPED` 事件机制仍然正常工作

| 步骤 | 操作                                   | 预期结果                        |
| ---- | -------------------------------------- | ------------------------------- |
| 1    | 打开角色卡，进入开场白阶段             | 播放器正常显示，音乐可播放      |
| 2    | 使用**原生左右滑动**切换到另一个开场白 | -                               |
| 3    | 观察控制台日志                         | 应出现 `[Event-Swipe]` 相关日志 |
| 4    | 观察播放器状态                         | 歌单应切换为新开场白配置的歌单  |

**重点检查**:
- [ ] 软重置只执行**一次**（不应重复执行）
- [ ] 如果之前在播放，切换后应自动继续播放

---

### TC-002: 前端按钮跳转开场白（新功能验证）

**目的**: 验证轮询监视器能检测到非标准方式的开场白切换

| 步骤 | 操作                                             | 预期结果                                                  |
| ---- | ------------------------------------------------ | --------------------------------------------------------- |
| 1    | 打开一个**角色卡内嵌前端界面带跳转按钮**的角色卡 | 播放器正常显示                                            |
| 2    | 观察控制台日志                                   | 应出现 `[GreetingWatcher] 启动开场白轮询监视器`           |
| 3    | 通过前端按钮**跳转到另一个开场白**               | -                                                         |
| 4    | 观察控制台日志                                   | 应出现 `[GreetingWatcher] 检测到开场白变化: swipe X -> Y` |
| 5    | 观察播放器状态                                   | 歌单应正确切换                                            |

**重点检查**:
- [ ] 控制台日志显示轮询监视器正确检测到变化
- [ ] 播放器界面更新为新歌单
- [ ] 无 "播放器显示没有歌单" 的问题

---

### TC-003: 开始聊天后监视器自动停止

**目的**: 验证用户开始聊天后轮询监视器正确停止，不浪费资源

| 步骤 | 操作                         | 预期结果                                                              |
| ---- | ---------------------------- | --------------------------------------------------------------------- |
| 1    | 打开角色卡，停留在开场白阶段 | `[GreetingWatcher] 启动...` 日志出现                                  |
| 2    | 发送第一条消息               | -                                                                     |
| 3    | 观察控制台日志               | 应出现 `[GreetingWatcher] 检测到消息数=2，开场白阶段结束，停止监视器` |
| 4    | 继续聊天                     | 无更多 `[GreetingWatcher]` 日志                                       |

**重点检查**:
- [ ] 监视器在消息数 > 1 后自动停止
- [ ] 停止后无多余的轮询日志

---

## 二、边界条件测试

### TC-004: 快速连续切换开场白

**目的**: 验证互斥锁机制能防止重复软重置

| 步骤 | 操作                                      | 预期结果 |
| ---- | ----------------------------------------- | -------- |
| 1    | 打开角色卡，停留在开场白阶段              | -        |
| 2    | **快速连续**滑动或点击切换开场白（3-5次） | -        |
| 3    | 观察控制台日志                            | -        |

**重点检查**:
- [ ] 应出现 `[SoftReset] 请求被合并：已有软重置正在进行中` 日志
- [ ] 软重置最终只执行**一次有效操作**
- [ ] 最终状态对应最后一次切换的开场白

---

### TC-005: 删除消息后回到开场白阶段

**目的**: 验证删除消息后监视器能重新启动

| 步骤 | 操作                               | 预期结果                                                   |
| ---- | ---------------------------------- | ---------------------------------------------------------- |
| 1    | 打开角色卡，发送一条消息           | 监视器应已停止                                             |
| 2    | 删除这条消息，回到只有开场白的状态 | -                                                          |
| 3    | 观察控制台日志                     | 应出现 `[EventAdapter] 删除后消息数=1，重新启动轮询监视器` |
| 4    | 通过非标准方式切换开场白           | 监视器应能检测到变化                                       |

**重点检查**:
- [ ] 删除消息后监视器正确重启
- [ ] 重启后的监视器功能正常

---

### TC-006: 角色卡无歌单配置

**目的**: 验证无歌单时不会崩溃

| 步骤 | 操作                           | 预期结果 |
| ---- | ------------------------------ | -------- |
| 1    | 打开一个**未配置歌单**的角色卡 | -        |
| 2    | 观察控制台和播放器             | -        |

**重点检查**:
- [ ] 无报错
- [ ] 播放器显示"没有歌单"或被正确隐藏
- [ ] 轮询监视器不会导致额外错误

---

## 三、清理逻辑测试

### TC-007: 切换聊天（硬重置）

**目的**: 验证切换聊天时监视器被正确清理

| 步骤 | 操作                           | 预期结果                                                             |
| ---- | ------------------------------ | -------------------------------------------------------------------- |
| 1    | 打开角色卡 A，停留在开场白阶段 | 监视器启动                                                           |
| 2    | 切换到另一个角色卡 B           | -                                                                    |
| 3    | 观察控制台日志                 | 应出现 `[HardReset]` 相关日志和 `[GreetingWatcher] 轮询监视器已停止` |
| 4    | 在角色卡 B 中操作              | 无来自角色卡 A 监视器的干扰                                          |

**重点检查**:
- [ ] 监视器在硬重置时被停止
- [ ] 无内存泄漏或残留定时器

---

### TC-008: 刷新页面

**目的**: 验证刷新页面时监视器被正确清理

| 步骤 | 操作                         | 预期结果   |
| ---- | ---------------------------- | ---------- |
| 1    | 打开角色卡，停留在开场白阶段 | 监视器启动 |
| 2    | 刷新浏览器页面 (F5)          | -          |
| 3    | 页面重新加载后观察控制台     | -          |

**重点检查**:
- [ ] 刷新前应触发 `PAGEHIDE` 事件和监视器停止日志
- [ ] 刷新后脚本重新正常初始化

---

## 四、性能测试

### TC-009: 轮询期间资源占用

**目的**: 验证轮询不会造成明显性能影响

| 步骤 | 操作                               | 预期结果   |
| ---- | ---------------------------------- | ---------- |
| 1    | 打开角色卡，停留在开场白阶段       | 监视器启动 |
| 2    | 打开开发者工具 -> Performance 面板 | -          |
| 3    | 等待 30 秒，期间不做任何操作       | -          |
| 4    | 检查 CPU 占用                      | -          |

**重点检查**:
- [ ] CPU 占用几乎无感知 (< 1%)
- [ ] 无明显内存增长

---

## 五、回归测试

### TC-010: 正常播放功能

**目的**: 确保新功能不影响现有播放功能

| 测试项        | 预期结果 | 通过 |
| ------------- | -------- | ---- |
| 播放/暂停     | 正常工作 | [ ]  |
| 上一曲/下一曲 | 正常工作 | [ ]  |
| 歌单切换      | 正常工作 | [ ]  |
| 音量调节      | 正常工作 | [ ]  |
| 播放模式切换  | 正常工作 | [ ]  |
| 进度条拖动    | 正常工作 | [ ]  |

---

### TC-011: MVU 模式兼容性

**目的**: 确保 MVU 模式下功能正常

| 步骤 | 操作                      | 预期结果       |
| ---- | ------------------------- | -------------- |
| 1    | 打开一个 MVU 模式的角色卡 | -              |
| 2    | 测试开场白切换            | 歌单正确更新   |
| 3    | 测试场景触发器            | 触发器正常工作 |

---

### TC-012: 文本模式兼容性

**目的**: 确保文本（纯文字）模式下功能正常

| 步骤 | 操作                     | 预期结果     |
| ---- | ------------------------ | ------------ |
| 1    | 打开一个文本模式的角色卡 | -            |
| 2    | 测试开场白切换           | 歌单正确更新 |
| 3    | 测试 `<scene:xxx>` 标签  | 标签正常解析 |

---

## 测试结果汇总

| 测试用例 | 结果 | 备注 |
| -------- | ---- | ---- |
| TC-001   | ⬜    |      |
| TC-002   | ⬜    |      |
| TC-003   | ⬜    |      |
| TC-004   | ⬜    |      |
| TC-005   | ⬜    |      |
| TC-006   | ⬜    |      |
| TC-007   | ⬜    |      |
| TC-008   | ⬜    |      |
| TC-009   | ⬜    |      |
| TC-010   | ⬜    |      |
| TC-011   | ⬜    |      |
| TC-012   | ⬜    |      |

**图例**: ✅ 通过 | ❌ 失败 | ⬜ 未测试

---

## 常见问题排查

### 问题 1: 监视器未启动
**检查点**:
- 消息数是否为 1（只有开场白）
- `isCorePlayerInitialized` 是否为 true
- 控制台是否有初始化错误

### 问题 2: 切换开场白后歌单未更新
**检查点**:
- 控制台是否有 `[GreetingWatcher]` 或 `[SoftReset]` 相关日志
- 新开场白是否正确配置了 `<playlist:xxx>` 标签
- swipe_id 是否真的发生了变化

### 问题 3: 软重置被重复执行
**检查点**:
- 是否出现 `[SoftReset] 请求被合并` 日志
- `_isSoftResetting` 锁是否正常工作
