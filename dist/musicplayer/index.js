const e=z;performance.now();const t=e.z.object({歌名:e.z.string().optional(),歌手:e.z.string().optional(),封面:e.z.string().url({message:'封面URL格式无效'}).optional(),url:e.z.string().url({message:'音轨URL格式无效'})}).strict(),n=e.z.object({variable_path:e.z.string(),greater_than:e.z.number().optional(),greater_than_or_equal_to:e.z.number().optional(),less_than:e.z.number().optional(),less_than_or_equal_to:e.z.number().optional(),value:e.z.union([e.z.string(),e.z.number(),e.z.boolean()]).optional(),value_contains:e.z.string().optional(),time_in_range:e.z.string().regex(/^\d{2}:\d{2}-\d{2}:\d{2}$/,{message:'时间范围格式必须是 "HH:MM-HH:MM"'}).optional()}).strict(),a=e.z.object({type:e.z.literal('mvu_variable'),playlist_id:e.z.string(),priority:e.z.number().default(0),conditions:e.z.array(n).nonempty({message:'触发器必须至少包含一个条件'})}).strict(),r=e.z.object({id:e.z.string(),onFinishRule:e.z.enum(['loop','pop'],{message:'onFinishRule 必须是 \'loop\' 或 \'pop\''}).default('loop'),tracks:e.z.array(t).nonempty({message:'歌单的 \'tracks\' 列表不能为空'})}),i=e.z.object({default_playlist_id:e.z.string().optional(),playlists:e.z.array(r).optional(),triggers:e.z.array(a).optional()}).strict(),o=e.z.object({playlistId:e.z.string(),currentIndex:e.z.number().default(0),playedIndices:e.z.array(e.z.number()).default([]),wasEverPlayed:e.z.boolean().default(!1),triggerSource:a.optional()}),s=e.z.object({active_queue:e.z.array(o),mode:e.z.enum(['list','single','random']).default('list'),volume:e.z.number().min(0).max(1).default(.5),previousMvuState:e.z.record(e.z.string(),e.z.any()).optional()}),l='灰烬双星_MVU状态记忆';function c(e){if(!e||'string'!=typeof e)return null;const t=e.trim().replace('：',':');let n;if(n=t.match(/^(\d{1,2})\s*:\s*(\d{1,2})$/),n){const e=parseInt(n[1],10),t=parseInt(n[2],10);if(e>=0&&e<24&&t>=0&&t<60)return 60*e+t}if(n=t.match(/^(\d{1,2})\s*时\s*(\d{1,2})\s*分?$/),n){const e=parseInt(n[1],10),t=parseInt(n[2],10);if(e>=0&&e<24&&t>=0&&t<60)return 60*e+t}return null}const u=(()=>{let e={};function t(e,t){if(!t)return!1;for(const n of e.conditions){const e=_.get(t,n.variable_path);let a=!1,r=!1;if(void 0!==n.value_contains)r=!0,'string'==typeof e&&e.includes(n.value_contains)&&(a=!0);else if(void 0!==n.time_in_range){if(r=!0,'string'==typeof e){const t=c(e);if(null!==t){const[e,r]=n.time_in_range.split('-'),i=c(e),o=c(r);null!==i&&null!==o&&(a=i<=o?t>=i&&t<=o:t>=i||t<=o)}}}else void 0!==n.value?(r=!0,e===n.value&&(a=!0)):void 0!==n.greater_than?(r=!0,'number'==typeof e&&e>n.greater_than&&(a=!0)):void 0!==n.greater_than_or_equal_to?(r=!0,'number'==typeof e&&e>=n.greater_than_or_equal_to&&(a=!0)):void 0!==n.less_than?(r=!0,'number'==typeof e&&e<n.less_than&&(a=!0)):void 0!==n.less_than_or_equal_to&&(r=!0,'number'==typeof e&&e<=n.less_than_or_equal_to&&(a=!0));if(!r||!a)return!1}return!0}return{checkTriggerCondition:t,initialize(){try{const t=getVariables({type:'chat'})[l];e=t&&'object'==typeof t?t:{}}catch(t){e={}}},resetState(){e={}},async persistCurrentState(t){if(x){e=_.cloneDeep(t);try{await updateVariablesWith(t=>(t[l]=e,t),{type:'chat'})}catch(e){}}},getPreviousState:()=>_.cloneDeep(e),calculateChangeReport(e,n,a){const r={newlyActiveTriggers:[],newlyInactiveTriggers:[]};for(const i of a){const a=t(i,e),o=t(i,n);!a&&o?(i.playlist_id,r.newlyActiveTriggers.push(i)):a&&!o&&(i.playlist_id,r.newlyInactiveTriggers.push(i))}return r.newlyActiveTriggers.length,r.newlyInactiveTriggers.length,r}}})(),d=(()=>{let e=[],t='list',n=.5,a=!1,r=!1;function i(e,t){'number'!=typeof t||t<0||e.playedIndices.add(t)}return{getPlaybackMode:()=>t,getVolume:()=>n,isPlaying:()=>a,isPerformingEffect:()=>r,getTopQueueItem:()=>_.cloneDeep(e[0]),getQueue:()=>_.cloneDeep(e),getStateSnapshotForRuntime:()=>_.cloneDeep({active_queue:e,mode:t,volume:n,isPlaying:a,isPerformingEffect:r}),getStateSnapshotForPersistence:()=>({active_queue:_.cloneDeep(e).map(e=>({..._.omit(e,['playbackPlan','planIndex','playlistContent']),playedIndices:Array.from(e.playedIndices)})),mode:t,volume:n}),resetState(){e=[],t='list',n=.5,a=!1,r=!1},loadState(a){t=a.mode,n=a.volume,e=a.active_queue||[],e.length},setPlaybackMode:e=>{t=e},setVolume:e=>{n=e},setPlaying:e=>{a=e},setPerformingEffect:e=>{r=e},updateQueue(t){t.length,e=_.cloneDeep(t).sort((e,t)=>t.priority-e.priority),e.length>0&&(e[0].playlistId,e[0].priority)},setCurrentIndex(t){const n=e[0];n&&(i(n,n.currentIndex),n.currentIndex=t)},commitNavigationStep(n){const a=e[0];if(a){if(i(a,a.currentIndex),'random'===t&&a.playbackPlan){const e=a.playbackPlan.indexOf(n);-1!==e&&(a.planIndex=e)}a.currentIndex=n}},clearHistoryForCurrentItem(){const t=e[0];t&&t.playedIndices.clear()},resetCurrentItemForLoop(){const t=e[0];t&&(t.playedIndices.clear(),t.currentIndex=0)},commitGenesisState(t,n,a){const r=e[0];r&&(r.currentIndex=t,r.playbackPlan=n,r.planIndex=a)},userInitiatedJump(t){const n=e[0];if(n&&t!==n.currentIndex&&(i(n,n.currentIndex),n.currentIndex=t,'random'===this.getPlaybackMode()&&n.playbackPlan)){const e=n.playbackPlan.indexOf(t);-1!==e&&(n.planIndex=e)}},clearRandomModePlan(){const t=e[0];t&&(t.playbackPlan=void 0,t.planIndex=void 0)},applyNewPlaybackPlan(t,n){const a=e[0];a&&(a.playbackPlan=t,a.planIndex=n)}}})(),y=(()=>{let e=null,t=null,n=null,a=null,r=null;function i(e,t,n){return new Promise(a=>{if(r&&(clearInterval(r),r=null),!e)return a();const i=e.volume,o=n/50;if(o<=0)return e.volume=t,a();const s=(t-i)/o;let l=0;r=window.setInterval(()=>{l++,l>=o?(r&&clearInterval(r),r=null,e.volume=t,a()):e.volume+=s},50)})}return{initialize(){if(e&&t)return;const r=()=>{const e=new Audio;return e.preload='auto',e.crossOrigin='anonymous',e.addEventListener('ended',()=>{e===n&&async function(){if(d.isPerformingEffect())return;const e=d.getTopQueueItem();if(!e)return;try{d.setPerformingEffect(!0),R();const t=m.getCurrentStrategy().onTrackEnd(e),n=await U(t);n.needsAsyncEffect&&'number'==typeof n.targetIndex&&await q(n.targetIndex)}catch(e){await H()}finally{await W(),await F('trackEnded')}}()}),e.addEventListener('error',()=>{}),e.addEventListener('timeupdate',Q),e};e=r(),t=r(),n=e,a=t},getActivePlayer:()=>n,getStandbyPlayer:()=>a,async transitionToTrack(e,t){if(e.slice(0,50),!a||!n)throw new Error('播放器实例尚未初始化');const r=a,o=n;r.src=e,r.load();try{await new Promise((e,t)=>{const n=()=>{r.removeEventListener('canplaythrough',n),r.removeEventListener('error',a),e()},a=e=>{r.removeEventListener('canplaythrough',n),r.removeEventListener('error',a);const i=e.target.error;t(new Error(`音频加载失败: ${i?.message||'未知错误'}`))};r.addEventListener('canplaythrough',n),r.addEventListener('error',a)})}catch(e){throw e}await i(o,0,500),o.pause(),[n,a]=[a,n];const s=this.getActivePlayer();if(!s)throw new Error('播放器实例在交换后丢失');const l=s.play();l&&await l,await i(s,t,500)},async fadeOutAndPause(){await i(n,0,400),n?.pause()},async executeHardCut(e,t){e.slice(0,50);const n=this.getActivePlayer();if(!n)throw new Error('No active player available for hard cut.');n.src.slice(-50),n.pause(),n.src=e,n.volume=t,n.src.slice(-50);try{const e=n.play();e&&await e,d.setPlaying(!0)}catch(e){throw d.setPlaying(!1),e}},async resumeAndFadeIn(e){const t=n?.play();t&&await t,await i(n,e,400)}}})();class g{onQueueChanged(e){}advance(e,t){if(e.playlistId,e.currentIndex,e.onFinishRule,'next'===t)return this.onTrackEnd(e);const{currentIndex:n,onFinishRule:a,playlistContent:r}=e,i=r.length;if(n>0){const e=n-1;return{action:'GoTo',nextIndex:e}}if('loop'===a){const e=i>0?i-1:0;return{action:'GoTo',nextIndex:e}}return{action:'Restart'}}onTrackEnd(e){e.playlistId,e.currentIndex,e.onFinishRule;const{currentIndex:t,onFinishRule:n,playlistContent:a,playedIndices:r}=e,i=t+1;if(i<a.length)return{action:'GoTo',nextIndex:i};if('pop'===n)return{action:'RemoveTopAndAdvance'};{const e=a.length;return r.size+1>=e?{action:'LoopReset'}:{action:'GoTo',nextIndex:0}}}onPlaybackError(e){return this.advance(e,'next')}}class p{onQueueChanged(e){}advance(e,t){return{action:'Restart'}}onTrackEnd(e){return{action:'Restart'}}onPlaybackError(e){return{action:'Stop'}}}class f{_generateIntelligentShuffle(e,t,n){e.length,t.size;const a=e.filter(e=>!t.has(e)&&e!==n);a.length;for(let e=a.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[a[e],a[t]]=[a[t],a[e]]}return a.join(', '),a}_generatePlaybackPlan(e,t,n){e.size,n.length;const a=Array.from(new Set([...e,t])),r=a.indexOf(t),i=[...a,...n];return a.join(', '),i.join(', '),{playbackPlan:i,planIndex:r}}_handlePlanEnd(e){return e.playlistId,e.onFinishRule,'pop'===e.onFinishRule?{action:'RemoveTopAndAdvance'}:{action:'LoopReset'}}onQueueChanged(e){if(!e)return;e.playlistId;const t=e.playlistContent.map((_,e)=>e),n=this._generateIntelligentShuffle(t,e.playedIndices,e.currentIndex),{playbackPlan:a,planIndex:r}=this._generatePlaybackPlan(e.playedIndices,e.currentIndex,n);d.applyNewPlaybackPlan(a,r)}prepareGenesis(e){if(!e||!e.playlistContent)return null;const t=e.playlistContent.map((_,e)=>e);for(let e=t.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}const n=t,a=n[0];return{newCurrentIndex:a,newPlaybackPlan:n,newPlanIndex:0}}advance(e,t){const{playbackPlan:n,planIndex:a}=e;if(!n||void 0===a)return{action:'DoNothing'};if(n.join(', '),'next'===t){const t=a+1;if(t<n.length){const e=n[t];return{action:'GoTo',nextIndex:e}}return this._handlePlanEnd(e)}{const e=a-1;if(e>=0){const t=n[e];return{action:'GoTo',nextIndex:t}}return{action:'DoNothing'}}}onTrackEnd(e){const{playbackPlan:t,planIndex:n}=e;if(!t||void 0===n)return{action:'Stop'};t.join(', ');const a=n+1;if(a<t.length){const e=t[a];return{action:'GoTo',nextIndex:e}}return this._handlePlanEnd(e)}onPlaybackError(e){return this.advance(e,'next')}}const m=(()=>{const e={list:new g,single:new p,random:new f};let t=e.list;return{setMode(n){t=e[n]},getCurrentStrategy:()=>t,notifyQueueChanged(){t.constructor.name;const e=d.getTopQueueItem();t.onQueueChanged(e)}}})(),I='余烬双星_播放器状态';let h=!1,v=!1,P=null,w=null,x=!0,b={},E=[],C='',T=!1,S=!1,k=null;const A=[],M=[];async function D(e,t){if(!v){v=!0;try{d.setPerformingEffect(!0),R();try{const n=d.getTopQueueItem(),a=e?.stat_data?e.stat_data:(await j())?.mvuData?.stat_data??{},r=u.getPreviousState(),i=u.calculateChangeReport(r,a,E),o=d.getQueue();if(i.newlyInactiveTriggers.length>0&&(_.remove(o,e=>i.newlyInactiveTriggers.some(t=>O(e.triggerSource,t))),i.newlyInactiveTriggers.length),i.newlyActiveTriggers.length>0)for(const e of i.newlyActiveTriggers){if(o.some(t=>t.triggerSource&&O(t.triggerSource,e))){e.playlist_id;continue}const t=N({type:'mvu',playlistId:e.playlist_id,trigger:e});t&&(o.push(t),t.playlistId)}d.updateQueue(o);const s=d.getTopQueueItem();if(s?.playlistId!==n?.playlistId&&s){m.notifyQueueChanged(),s.wasEverPlayed=!0;const e=s.wasEverPlayed?s.currentIndex:0;if(d.isPlaying())'hard'===t?.transitionEffect?await y.executeHardCut(s.playlistContent[e].url,d.getVolume()):await q(e);else{const t=s.playlistContent[e],n=y.getActivePlayer();t&&n&&(n.src=t.url)}}await u.persistCurrentState(a)}catch(e){}finally{await F('reconciliation')}}finally{v=!1,await W()}}}function R(){const e=d.getTopQueueItem(),t=e?.playlistContent??[],n=e?.currentIndex??0,a={currentItem:t[n]?{title:t[n].歌名,artist:t[n].歌手,cover:t[n].封面}:null,isPlaying:d.isPlaying(),playbackMode:d.getPlaybackMode(),masterVolume:d.getVolume(),playlist:t.map(e=>({title:e.歌名,artist:e.歌手,cover:e.封面})),isTransitioning:d.isPerformingEffect()};A.forEach(e=>{try{e(a)}catch(e){}})}function Q(){const e=y.getActivePlayer();if(!d.isPlaying()||!e)return;const t={currentTime:e.currentTime,duration:e.duration||0};M.forEach(e=>e(t))}async function F(e){if(x)try{const e=d.getStateSnapshotForPersistence();await updateVariablesWith(t=>(t[I]=e,t),{type:'chat'})}catch(e){}}function L(e){const t=e.issues[0],n=t.path.join(' -> '),a=t.message,r=`路径: ${n} | 问题: ${a}`;toastr.error(r,'[MusicConfig] 内容错误',{timeOut:15e3})}function O(e,t){if(!e||!t)return e===t;if(e.playlist_id!==t.playlist_id)return!1;const n=e=>Object.keys(e).sort().map(t=>`${t}:${String(e[t])}`).join(','),a=e.conditions.map(n).sort(),r=t.conditions.map(n).sort();return a.length===r.length&&a.every((e,t)=>e===r[t])}async function j(e){if(e&&0===e.messageId&&'number'==typeof e.swipeId){e.messageId,e.swipeId;try{const t=await Mvu.getMvuData({type:'message',message_id:0}),n=t?.swipes_data?.[e.swipeId];if(n?.stat_data)return{mvuData:n,messageId:0};if(t?.stat_data)return{mvuData:t,messageId:0}}catch(e){}}try{const e=getChatMessages(-1,{include_swipes:!0});for(let t=e.length-1;t>=0;t--){const n=e[t].message_id;if('number'==typeof n)try{const e=await Mvu.getMvuData({type:'message',message_id:n});if(e?.stat_data)return{mvuData:e,messageId:n}}catch(e){}}return null}catch(e){return null}}async function V(){const e={playlists:[],triggers:[],defaultPlaylistId:void 0,_defaultPlaylistIdSourceFile:null};try{const t=getCharWorldbookNames('current'),n=[t.primary,...t.additional].filter(Boolean);let a=!1;for(const t of n){if(!t)continue;const n=(await getWorldbook(t)).filter(e=>e.name.includes('[MusicConfig]'));n.length>0&&(a=!0);for(const t of n){t.name;try{const n=YAML.parse(t.content),a=i.safeParse(n);if(!a.success){t.name,L(a.error);continue}const r=a.data;if(r.playlists&&e.playlists.push(...r.playlists.map(e=>({...e,_sourceFile:t.name}))),r.triggers&&e.triggers.push(...r.triggers.map(e=>({...e,_sourceFile:t.name}))),r.default_playlist_id){if(e.defaultPlaylistId&&e.defaultPlaylistId!==r.default_playlist_id){const n=`在文件 "${t.name}" 中发现的 default_playlist_id ("${r.default_playlist_id}") 覆盖了来自文件 "${e._defaultPlaylistIdSourceFile??'未知'}" 的定义 ("${e.defaultPlaylistId}")。为确保行为可预测，建议只保留一个定义。`;toastr.warning(n,'配置警告',{timeOut:2e4,closeButton:!0})}e.defaultPlaylistId=r.default_playlist_id,e._defaultPlaylistIdSourceFile=t.name}}catch(e){t.name,e.message,toastr.error(`[MusicConfig] 文件 "${t.name}" 格式错误：YAML 语法不正确。`,'配置错误',{timeOut:1e4})}}}if(!a)return null;let r=!0;const o=_.groupBy(e.playlists,'id');for(const e in o)if(o[e].length>1){const t=`[MusicConfig] 致命错误: 歌单 ID "${e}" 在多个文件中重复定义。来源: ${o[e].map(e=>e._sourceFile).join(', ')}。ID 必须是唯一的。`;toastr.error(t,'配置冲突',{timeOut:15e3}),r=!1}const s=new Set(e.playlists.map(e=>e.id));if(e.defaultPlaylistId&&!s.has(e.defaultPlaylistId)){const t=`[MusicConfig] 配置错误: 最终的 default_playlist_id ("${e.defaultPlaylistId}", 来自文件 "${e._defaultPlaylistIdSourceFile??'未知'}") 指向了一个不存在的歌单。`;toastr.error(t,'配置错误',{timeOut:15e3}),e.defaultPlaylistId=void 0}const l=e.triggers.filter(e=>{if(s.has(e.playlist_id))return!0;const t=`[MusicConfig] 校验失败: 来自文件 "${e._sourceFile}" 的触发器指向了不存在的歌单ID "${e.playlist_id}"。该触发器将被忽略。`;return toastr.error(t,'配置错误',{timeOut:1e4}),!1});if(!r)return null;if(0===e.playlists.length){const e='[MusicConfig] 致命错误: 所有配置文件中都未能找到任何有效的歌单 (playlists)。播放器无法加载。';return toastr.error(e,'配置错误',{timeOut:15e3}),null}const c={};for(const t of e.playlists){const e=t.tracks.map(e=>({url:e.url,歌名:e.歌名&&''!==e.歌名.trim()?e.歌名:decodeURIComponent(e.url.split('/').pop()?.split('?')[0]||'未知歌曲'),歌手:e.歌手,封面:e.封面}));c[t.id]={..._.omit(t,'_sourceFile'),tracks:e}}return{playlists:c,defaultId:e.defaultPlaylistId,triggers:l.map(e=>_.omit(e,'_sourceFile'))}}catch(e){return toastr.error('音乐配置加载时发生未知错误，请检查控制台日志。'),null}}function G(e,t){return{playlistId:e.playlistId,priority:e.triggerSource?.priority??-1/0,playlistContent:_.cloneDeep(t.tracks),onFinishRule:t.onFinishRule,currentIndex:e.currentIndex,playedIndices:new Set(e.playedIndices),wasEverPlayed:e.wasEverPlayed,triggeredBy:e.triggerSource?'mvu':'base',triggerSource:e.triggerSource}}function N(e){const{playlistId:t}=e;if(!t||!b[t])return null;const n=b[t],a={playlistId:t,playlistContent:_.cloneDeep(n.tracks),currentIndex:0,playedIndices:new Set,wasEverPlayed:!1};return'base'===e.type?{...a,priority:-1/0,triggeredBy:'base',onFinishRule:'loop'}:{...a,priority:e.trigger.priority,triggeredBy:'mvu',onFinishRule:n.onFinishRule,triggerSource:e.trigger}}async function B(e,t,n){try{S=!0,d.resetState(),u.resetState(),u.initialize();const a=y.getActivePlayer();if(a&&a.pause(),E=[],b={},C='',!e)throw R(),new Error('世界书音乐配置解析失败，请检查配置。');b=e.playlists,C=e.defaultId,E=e.triggers;const r=function(){const e=getVariables({type:'chat'})[I];if(!e||'object'!=typeof e)return null;const t=s.safeParse(e);return t.success?t.data:null}(),i=t?.mvuData?.stat_data??null,o=t?.messageId;let l=[],c=C;const g=getChatMessages(0,{include_swipes:!0})[0];if(g){const e=g.swipes?.[g.swipe_id],t=e?.match(/<playlist:([^>]+)>/);if(t&&t[1]){const e=t[1];if(b[e])c=e;else{const t=`[MusicConfig] 配置警告: 开场白标签 <playlist:${e}> 指向了一个不存在的歌单ID。将回退至默认歌单。`;toastr.warning(t,'配置警告',{timeOut:15e3})}}}if(c){if(new Set(E.map(e=>e.playlist_id)).has(c)){const e=`[MusicConfig] 致命配置错误: 歌单 "${c}" 不能同时被用作基础歌单（在开场白或默认设置中）和场景歌单（被触发器关联）。请为它们使用不同的歌单。`;throw toastr.error(e,'配置冲突',{timeOut:2e4,closeButton:!0}),new Error('基础歌单与场景歌单存在致命冲突。')}}if(r){const e=[];for(const t of r.active_queue){if(!Object.prototype.hasOwnProperty.call(b,t.playlistId)){t.playlistId;continue}const n=b[t.playlistId];if(!t.triggerSource)t.playlistId===c?(t.playlistId,e.push(G(t,n))):t.playlistId;else{const a=E.find(e=>e.playlist_id===t.playlistId);if(t.playlistId,'pop'===n.onFinishRule)continue;if(!a)continue;if(!u.checkTriggerCondition(a,i))continue;e.push(G(t,n))}}l=e}if(i&&E.length>0)for(const e of E){if(!l.some(t=>t.triggerSource&&O(t.triggerSource,e))&&u.checkTriggerCondition(e,i)){const t=b[e.playlist_id];if(t&&'pop'===t.onFinishRule)if(0===o){e.playlist_id;const t=N({type:'mvu',playlistId:e.playlist_id,trigger:e});t&&l.push(t)}else e.playlist_id;else{const t=N({type:'mvu',playlistId:e.playlist_id,trigger:e});t&&l.push(t)}}}if(!l.some(e=>'base'===e.triggeredBy)&&c&&b[c]){const e=N({type:'base',playlistId:c});e&&l.push(e)}d.updateQueue(l);const p=r?.mode??'list';d.setPlaybackMode(p),m.setMode(p),m.notifyQueueChanged(),y.initialize();const f=r?.volume??.5;d.setVolume(f),y.getActivePlayer()&&(y.getActivePlayer().volume=f),y.getStandbyPlayer()&&(y.getStandbyPlayer().volume=0);const h=d.getTopQueueItem();if(h){const e=h.playlistContent[h.currentIndex];e&&y.getActivePlayer()&&(y.getActivePlayer().src=e.url)}if(i?await u.persistCurrentState(i):await u.persistCurrentState({}),await F(),R(),n?.autoPlayIfWasPlaying){d.getTopQueueItem()&&await async function(){if(d.isPerformingEffect())return;const e=d.getTopQueueItem();if(!e)return;try{d.setPerformingEffect(!0),e.currentIndex,d.setPlaying(!0),R(),await q(e.currentIndex)}catch(e){d.setPlaying(!1),R()}finally{await W(),await F()}}()}}catch(e){throw e}}async function q(e){const t=d.getTopQueueItem();if(!t)return Promise.resolve();const n=t.playlistContent[e];if(!n?.url)throw new Error(`Invalid track at index ${e}`);try{await y.transitionToTrack(n.url,d.getVolume()),d.setPlaying(!0),function(){const e=d.getTopQueueItem(),t=y.getStandbyPlayer();if(!t||!e)return;const n=e.currentIndex+1;if(n<e.playlistContent.length){const a=e.playlistContent[n];a&&t.src!==a.url&&(t.src=a.url,t.load())}}()}catch(e){throw e}}async function H(){let e=1;const t=d.getTopQueueItem(),n=t?.playlistContent.length??0;for(t&&toastr.error(`歌曲《${t.playlistContent[t.currentIndex]?.歌名??'未知歌曲'}》加载失败，正在尝试自动处理...`);;){if(n>0&&e>=n)return t&&toastr.error(`歌单《${t.playlistId}》中所有歌曲均无法加载，播放已停止。`),d.setPlaying(!1),void R();const a=d.getTopQueueItem();if(!a)return d.setPlaying(!1),void R();const r=m.getCurrentStrategy().onPlaybackError(a);m.getCurrentStrategy().constructor.name,r.action;const i=await U(r);if(!i.needsAsyncEffect)return;if('number'!=typeof i.targetIndex)return d.setPlaying(!1),void R();try{return await q(i.targetIndex),void R()}catch(t){e++;const n=d.getTopQueueItem(),a=n?.playlistContent[n.currentIndex]?.歌名??'未知歌曲';toastr.error(`下一首《${a}》加载失败...`)}}}async function U(e){e.action,e.nextIndex;let t,n=!1;const a=d.getTopQueueItem();switch(e.action){case'GoTo':'number'==typeof e.nextIndex?(d.commitNavigationStep(e.nextIndex),n=!0,t=e.nextIndex):n=!1;break;case'Restart':a&&(n=!0,t=a.currentIndex);break;case'RemoveTopAndAdvance':{const e=d.getQueue();e.shift();d.updateQueue(e),m.notifyQueueChanged();const a=d.getTopQueueItem();a?(a.playlistId,a.currentIndex,n=!0,t=a.currentIndex):(d.setPlaying(!1),n=!1);break}case'LoopReset':{d.resetCurrentItemForLoop();if('random'===d.getPlaybackMode()){const e=m.getCurrentStrategy().prepareGenesis(d.getTopQueueItem());e&&d.commitGenesisState(e.newCurrentIndex,e.newPlaybackPlan,e.newPlanIndex)}const e=d.getTopQueueItem()?.currentIndex??0;n=!0,t=e;break}case'Stop':d.setPlaying(!1)}'RemoveTopAndAdvance'!==e.action&&R();const r={needsAsyncEffect:n,targetIndex:t};return r}async function W(){d.setPerformingEffect(!1),R()}async function J(e){if(d.isPerformingEffect())return;const t=d.getTopQueueItem();if(t)try{d.setPerformingEffect(!0),R();const n=m.getCurrentStrategy().advance(t,e),a=await U(n);if(n.action,a.needsAsyncEffect,'Restart'===n.action){const e=y.getActivePlayer();e&&(e.currentTime=0),'single'!==d.getPlaybackMode()&&toastr.info('已是第一首')}else a.needsAsyncEffect&&'number'==typeof a.targetIndex?await q(a.targetIndex):'DoNothing'===n.action&&toastr.info('next'===e?'已是歌单最后一首。':'已是歌单第一首。')}catch(e){await H()}finally{await W(),await F()}}function Y(){window.musicPlayerAPI={requestInitialization:()=>h?(R(),Promise.resolve()):(w||(w=new Promise((e,t)=>{P={resolve:e,reject:t}})),w),togglePlayPause:()=>async function(){if(d.isPerformingEffect())return;const e=d.getTopQueueItem();if(e)try{let t;d.setPerformingEffect(!0),R();const n=y.getActivePlayer(),a=e.currentIndex,r=n?.src,i=e.playlistContent[a]?.url;switch(t=d.isPlaying()?{action:'pause'}:n&&r===i&&n.currentTime>0?{action:'resume'}:{action:'playNew',targetIndex:a},'pause'!==t.action?d.setPlaying(!0):d.setPlaying(!1),R(),t.action){case'pause':await y.fadeOutAndPause();break;case'resume':await y.resumeAndFadeIn(d.getVolume());break;case'playNew':'number'==typeof t.targetIndex&&await q(t.targetIndex)}}catch(e){await H()}finally{await W(),await F()}else toastr.info('播放列表为空')}(),playNext:()=>{J('next')},playPrev:()=>{J('prev')},playIndex:e=>{const t=d.getTopQueueItem();t&&e>=0&&e<t.playlistContent.length&&async function(e){if(!d.isPerformingEffect())try{d.setPerformingEffect(!0),R();const t=d.getTopQueueItem(),n=d.getPlaybackMode();if(t&&e===t.currentIndex){const e=y.getActivePlayer();e&&(e.currentTime=0)}else'list'===n||'single'===n?(d.setCurrentIndex(e),await q(e)):'random'===n&&(d.userInitiatedJump(e),await q(e))}catch(e){await H()}finally{await W(),await F()}}(e)},persistVolumeAndBroadcast:e=>{const t=Math.max(0,Math.min(1,e)),n=y.getActivePlayer();d.setVolume(t),n&&!d.isPerformingEffect()&&(n.volume=t),F(),R()},setLiveVolume:e=>{const t=y.getActivePlayer();t&&!d.isPerformingEffect()&&(t.volume=Math.max(0,Math.min(1,e)))},setPlaybackMode:e=>{const t=d.getPlaybackMode();e!==t&&(d.setPlaybackMode(e),m.setMode(e),m.getCurrentStrategy().constructor.name,'random'===t&&d.clearRandomModePlan(),'random'===e&&m.notifyQueueChanged(),F(),R())},seekTo:e=>{const t=y.getActivePlayer();t?.duration&&(t.currentTime=t.duration*e)},getCurrentState:()=>{const e=d.getTopQueueItem(),t=e?.playlistContent??[],n=e?.currentIndex??0;return{currentItem:t[n]?{title:t[n].歌名,artist:t[n].歌手,cover:t[n].封面}:null,isPlaying:d.isPlaying(),playbackMode:d.getPlaybackMode(),masterVolume:d.getVolume(),playlist:t.map(e=>({title:e.歌名,artist:e.歌手,cover:e.封面})),isTransitioning:d.isPerformingEffect()}},onFullStateUpdate:e=>{'function'==typeof e&&A.push(e)},onTimeUpdate:e=>{'function'==typeof e&&M.push(e)}},initializeGlobal('musicPlayerAPI',window.musicPlayerAPI)}async function K(){if(h)return;const e=SillyTavern.getCurrentChatId?SillyTavern.getCurrentChatId():null;if(SillyTavern.chat.length>0&&null!==e){h=!0,k=e;try{const e=await V();if(!e)throw new Error('无法解析世界书配置，初始化中止。');const t=e.triggers&&Array.isArray(e.triggers)&&e.triggers.length>0;if(t){if(!await async function(){try{await waitGlobalInitialized('Mvu')}catch(e){return!1}const e=1e4,t=250,n=Date.now();let a=!1;for(;Date.now()-n<e;){try{const e=await Mvu.getMvuData({type:'message',message_id:0});if(e&&(e.swipes_data||e.stat_data)){a=!0;break}}catch(e){}await new Promise(e=>setTimeout(e,t))}if(!a)return!1;try{return function(){const e=e=>e=>{T&&S&&D(e)};eventOn(Mvu.events.VARIABLE_UPDATE_ENDED,e('VARIABLE_UPDATE_ENDED')),eventOn(tavern_events.MESSAGE_DELETED,e('MESSAGE_DELETED'))}(),T=!0,!0}catch(e){return T=!1,!1}}())throw new Error('MVU集成初始化失败或超时，部分功能将不可用。')}let n=null;t&&(n=await j()),await B(e,n),eventOn(tavern_events.CHARACTER_MESSAGE_RENDERED,e=>{!async function(e){if(0!==e)try{const t=getChatMessages(e)?.[0];'assistant'!==t?.role||t.message.includes('<DarkBramblePlayer/>')||await setChatMessages([{message_id:e,message:`${t.message}\n<DarkBramblePlayer/>`}])}catch(e){}}(e)}),eventOn(tavern_events.MESSAGE_SWIPED,e=>{if(S)if(0===e){const e=d.isPlaying();!async function(e){try{const t=await V(),n=await j();await B(t,n,e)}catch(e){}}({autoPlayIfWasPlaying:e})}else!async function(e,t){if(!S)return;const n=await j();n?.mvuData&&await D(n?.mvuData,t)}(0,{transitionEffect:'hard'})}),P&&P.resolve()}catch(e){if(P){const t=e instanceof Error?e.message:String(e);P.reject(t)}}finally{P=null}}}$(()=>{y.initialize(),Y(),eventOn(tavern_events.CHAT_CHANGED,()=>{x=!1,y.getActivePlayer()?.pause(),reloadIframe()});const e=setInterval(()=>{K(),h&&clearInterval(e)},250);setTimeout(()=>{h||(clearInterval(e),P&&(P.reject('Initialization timed out after 5 seconds.'),P=null))},5e3),$(window).on('pagehide',()=>{y.getActivePlayer()?.pause()})});export{s as ZodPersistedState,r as ZodPlaylistConfig,o as ZodQueueItemState,n as ZodSingleCondition,t as ZodTrackConfig,a as ZodTriggerConfig,i as ZodWorldbookConfig};
//# sourceMappingURL=index.js.map